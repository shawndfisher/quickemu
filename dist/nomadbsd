#!/usr/bin/env bash

INFO="nomadBSD|-|https://www.nomadbsd.org/|NomadBSD is a persistent live system for USB flash drives, based on FreeBSDÂ®. "

GUEST="nomadbsd"
IMAGE_TYPE="img"

#TODO eventually let's move this into quickget somewhere
function dist_requirements() {
    # Check if lzma is available
    LZMA=$(command -v lzma)
    if [ ! -e "${LZMA}" ]; then
        echo "Error! lzma not found. Please install lzma"
        # Maybe add some dist specific ways to get it?
        exit 1
    fi
}

function dist_releases() {
    echo $(web_pipe "https://mirrors.nomadlogic.org/nomadbsd/" | grep "<a href=\"nomadbsd" | cut -d"-" -f1 --complement | cut -d"." -f1 | sort -ru)
}

function dist_editions() {
    echo ufs zfs
}

function dist_image_get() {
    local HASH=""
    local URL="https://nomadbsd.org/download"
    local ISO="nomadbsd-${RELEASE}.amd64.${EDITION}.img.lzma"
    HASH=$(web_get "${ISO}.sha256" | cut -d'=' -f2 | tr -d ' ')
    echo "${URL}/${ISO} ${HASH}"
}

function dist_image_post_get() {
    dist_requirements
    if [[ ${ISO} = *".lzma"* ]]; then
        lzma -d ${VM_PATH}/${ISO}
        qemu-img convert -f raw -O qcow2 "${VM_PATH}/${ISO/.lzma}" "${VM_PATH}/disk.qcow2"
        qemu-img resize "${VM_PATH}/disk.qcow2" 16G
        ISO="${ISO/.lzma/}"
    fi
}

function dist_vm_option_tweak() {
    echo "boot=\"legacy\"" >> "${CONF_FILE}"
}

# vim:tabstop=4:shiftwidth=4:expandtab
